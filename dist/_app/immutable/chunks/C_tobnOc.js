import{g as C,c as g,a as f,b as R,d as c,e as S,f as w,s as b,h as O,i as T,j as k,u as E,k as L,l as F,m as I,n as $,o as j}from"./BWhKuY5S.js";import"./Bx8JZE7Z.js";import{i as M,a as D,b as _,c as p,d as y,e as J,f as K,s as U,$ as N,g as W}from"./DBxwzyNf.js";import{g as Y}from"./BGPMM1t7.js";import{b as l}from"./B3U6TAxr.js";let u=null;function h(){u&&(u.close(),u=null),y.set(!1)}async function V(){M.set(!0);let t=await C();const e=new Date,r=new Date(e.getFullYear(),e.getMonth(),e.getDate());if(t==1)return 1;if(t.code!=0)return t.code;let d=t.result,n=[];for(let a=d.length-1;a>=0;a--){let i=d[a],m=new Date(i.tm),o=new Date(m.getFullYear(),m.getMonth(),m.getDate());const s=Math.floor((r-o)/(1e3*60*60*24));n.push({cid:i.cid,name:i.name,tm:i.tm,daydiff:s,ai:i.ai,model:i.model})}return g.set(n),M.set(!1),0}async function X(){D.set(!0);let t=l(f),e=await R(t);if(e==1)return 1;if(e.code!=0)return e.code;let r=e.result,d=[];for(let n=0;n<r.length;n++){let a=r[n];d.push({message:{role:a.message.role,content:a.message.content},cid:a.cid,pid:a.pid,mid:a.mid,tm:a.tm,ai:a.ai,model:a.model,error_code:"0"})}return(t=l(f))&&c.set(d),D.set(!1),0}async function Z(t,e,r){let d=[];if(l(_)){let a=0;l(c).forEach(i=>{d.push({role:i.message.role,content:i.message.content,mid:Date.now()+a}),a++})}w.set(""),h(),y.set(!0);let n=0;if(c.update(a=>(a.length>=2&&(n=a[a.length-1].mid||0),a.push({message:{role:"user",content:t},cid:0,pid:0,mid:0,tm:0,ai:e,model:r,error_code:"0"}),a.push({message:{role:"assistant",content:"█"},cid:0,pid:0,mid:0,tm:0,ai:e,model:r,error_code:"0"}),a)),!l(J)&&!l(K)&&await Y()!=0){y.set(!1),U(l(N)("ERR.CONNECTION_FAILED",{default:"Failed to connect to server, try again later"}));return}u=await b(t,n,e,r,d),u.addEventListener("message",a=>{u.resetTimeout();let i=a.data,m=B(i);if(m){c.update(s=>(s[s.length-1].error_code=m.msg,s)),h();return}let o=A(i);o?(c.update(s=>(s[s.length-2].mid=o.pid,s[s.length-2].cid=o.cid,s[s.length-2].pid=l(p)||s.length==2?0:s[s.length-3].mid,s[s.length-2].tm=o.tm,s[s.length-1].tm=o.tm,s[s.length-1].cid=o.cid,s[s.length-1].message.content=l(w),s[s.length-1].mid=o.mid,s[s.length-1].pid=o.pid,s[s.length-1].ai=o.ai,s[s.length-1].model=o.model,s)),_.set(!1),h(),l(p)&&(f.set(o.cid),setTimeout(()=>{p.set(!1)},3*1e3))):(w.update(s=>s+i),c.update(s=>(s[s.length-1].message.content=l(w)+"●",s)))}),u.addEventListener("error",a=>{c.update(i=>(i[i.length-1].message.content=i[i.length-1].message.content.replace(/●​+$/,""),i[i.length-1].error_code="ERR_UNKNOW_NETWORKERROR",i)),h()})}function A(t){if(t.substring(0,6)=="[DONE]"){let e=JSON.parse(t.substring(6,t.length));return{mid:e.mid,cid:e.cid,tm:e.tm,pid:e.pid,ai:e.ai,model:e.model}}return!1}function B(t){if(t.substring(0,5)=="[ERR]"){let e=JSON.parse(t.substring(5,t.length));return{code:e.code,msg:e.msg}}return!1}async function x(t){let e=l(g)[t].cid,r=await $(e);return r==1?1:r.code!=0?r.code:(e==l(f)&&G(),g.update(d=>(d.splice(t,1),d)),0)}async function G(t=!1){h(),f.set(0),O(),l(_)&&(_.set(!1),c.set([])),p.set(!0),W.set(!t)}async function v(t,e){T.set(t),k.set(e);let r=await E(l(f),"",t,e);if(r==1)return 1;if(r.code!=0)return r.code;let d=L(l(f));return g.update(n=>(n[d].ai=t,n[d].model=e,n)),0}async function ee(t,e){let r=L(t),d=l(g)[r].name;g.update(a=>(a[r].name=l(N)("app.renaming"),a));let n=await E(t,e);return n==1?1:n.code!=0?n.code:(g.update(a=>(n.code==0?a[r].name=e:a[r].name=d,a)),0)}async function te(t,e=!1){let r=l(c)[t].cid,d=l(c)[t-1].mid,n=await j(r,d,e);return n==1?1:n.code!=0?n.code:(c.update(a=>(e?a.splice(t-1,a.length-t+1):a.splice(t-1,2),a)),0)}async function ae(t){let e=await S(t);if(e==1)return 1;if(e.code!=0)return e.code;if(e.result.length==0)return 1;c.update(r=>(r=e.result,r.forEach(d=>(d.error_code="0",r)),r)),_.set(!0),p.set(!0)}async function se(t){let e=await F(t);return e==1?1:e.code!=0?e.code:0}async function re(t){let e=await I(t);return e==1?1:e.code!=0?e.code:e.result}export{G as a,v as b,h as c,x as d,Z as e,te as f,ae as g,re as h,X as i,V as j,ee as r,se as s};
